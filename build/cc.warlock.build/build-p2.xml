<?xml version="1.0" encoding="UTF-8"?>
<project name="Warlock 2 Update Site" default="optimize">
	<property file="warlock-build.properties"/>
  <description>Prepare Warlock2 p2 Update Site</description>
	
  <taskdef resource="net/sf/antcontrib/antlib.xml">
    <classpath>
	  <pathelement location="lib/ant-contrib-1.0b3.jar"/>
    </classpath>
  </taskdef>
	
  <!-- =====================================================================
       UPDATE SITE OPTIMIZATION
       http://wiki.eclipse.org/Update_Site_Optimization
       http://plosquare.blogspot.com/2009/05/migrating-eclipse-update-sites-to-p2.html
       ===================================================================== -->
  <target name="optimize" description="Site Optimizer">

    <!-- LAUNCHER -->
    <pathconvert property="LAUNCHER">
      <fileset dir="${eclipseDir}/plugins" includes="org.eclipse.equinox.launcher_*.jar" />
    </pathconvert>
    <echo>LAUNCHER = '${LAUNCHER}' - when LAUNCHER is empty, create new property 'LAUNCHER'</echo>

    <!-- Step 4 and 5 -->

    <!-- 1. Part -->
    <echo>1. For each JAR file in question, "condition" or "repack" the JAR file to prepare it for the second part.</echo>
  	<foreach target="repackjar" param="file">
  		<fileset dir="${buildDirectory}/plugins">
  			<include name="**/*.jar"/>
  		</fileset>
  	</foreach>
  	
    <target name="repackjar">
  	  <java jar="${LAUNCHER}" fork="true" failonerror="true">
        <arg line="-debug -consolelog" />
        <arg line="-application org.eclipse.update.core.siteOptimizer" />
        <arg line="-jarProcessor -verbose -processAll -repack -outputDir ${buildDirectory}/plugins" />
        <arg line="${file}" />
      </java>
    </target>

    <!-- 2. Part -->
    <echo>2. Generate .jar.pack.gz files from a set of conditioned JAR files. Also generate digest.zip</echo>
    <java jar="${LAUNCHER}" fork="true" failonerror="true">
      <arg line="-debug -consolelog" />
      <arg line="-application org.eclipse.update.core.siteOptimizer" />
      <arg line="-digestBuilder" />
      <arg line="-digestOutputDir=${buildDirectory}" />
      <arg line="-siteXML=${buildDirectory}/site.xml" />
      <arg line="-jarProcessor -verbose -pack -outputDir ${buildDirectory} ${buildDirectory}" />
    </java>
  	
  	<java jar="${LAUNCHER}" fork="true" failonerror="true">
  		<arg line="-application org.eclipse.equinox.p2.metadata.generator.EclipseGenerator" />
  		<arg line="-updateSite ${buildDirectory}/" />
  		<arg line="-site file:${buildDirectory}/site.xml" />
  		<arg line="-metadataRepository file:${buildDirectory}/" />
  	    <arg line="-metadataRepositoryName &quot;Warlock 2 Update Site@quot;" />
  	    <arg line="-artifactRepository file:${buildDirectory}/" />
  	    <arg line="-artifactRepositoryName @quot;Warlock 2 Artifacts@quot;" />
  	    <arg line="-compress" />
  	    <arg line="-reusePack200Files" />
  	    <arg line="-noDefaultIUs" />
  	    <arg line="-vmargs -Xmx256M" />
  	</java>
  </target>
</project>